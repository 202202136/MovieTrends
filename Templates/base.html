<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Movie Trendhub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-dark text-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-black mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">Movie Trendhub</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/movies">Movies</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/watchlist">Watchlist</a>
                </li>
            </ul>

            <form class="d-flex mx-auto" role="search" method="get" action="/search">
                <input class="form-control me-2" type="search" placeholder="Search movies" aria-label="Search" name="q">
                <button class="btn btn-outline-light" type="submit">Search</button>
            </form>
        </div>
        <div class="d-flex ms-3">
    {% if session.get("user") %}
        <span class="navbar-text me-3">
            Welcome, {{ session.get("user").split('@')[0] }}
        </span>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-danger">
            Logout
        </a>
    {% else %}
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary me-2">
            Sign Up
        </a>
        <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">
            Log In
        </a>
    {% endif %}
</div>
    </div>
</nav>

<div class="container mb-5">
    {% block content %}{% endblock %}
</div>

</body>
<div id="flash-container" style="position:fixed;top:70px;right:20px;z-index:1200;min-width:280px"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Handle add/remove watchlist via AJAX and show a transient notification
// Fix: intercept watchlist forms via AJAX so UI updates only on backend success
document.addEventListener('submit', async function(e) {
    const form = e.target.closest('form.watchlist-action');
    if (!form) return;
    e.preventDefault();

    const action = form.dataset.action;
    const url = form.action;
    const formData = new FormData(form);

    try {
        const resp = await fetch(url, { method: 'POST', body: formData });
        const data = await resp.json();
        if (data && data.success) {
            showFlash(data.message || 'Saved');
            // toggle form action and button state
            const btn = form.querySelector('.watchlist-btn');
            if (action === 'add') {
                // switch to remove
                form.dataset.action = 'remove';
                form.action = '/remove_from_watchlist';
                if (btn) {
                    btn.textContent = 'Remove from Watchlist';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-danger');
                }
            } else if (action === 'remove') {
                // switch to add
                form.dataset.action = 'add';
                form.action = '/add_to_watchlist';
                if (btn) {
                    btn.textContent = 'Add to Watchlist';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-primary');
                }
                // if on watchlist page, remove the card from DOM
                const card = form.closest('.movie-item');
                if (card && window.location.pathname === '/watchlist') {
                    card.remove();
                }
            }
        } else {
            showFlash((data && data.error) || 'Action failed', 'danger');
        }
    } catch (err) {
        showFlash('Network error', 'danger');
    }
});

function showFlash(message, level='success'){
    const container = document.getElementById('flash-container');
    const id = 'flash-' + Date.now();
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `<div id="${id}" class="alert alert-${level} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
    container.appendChild(wrapper);
    setTimeout(()=>{
        const el = document.getElementById(id);
        if (el) { var bs = bootstrap.Alert.getOrCreateInstance(el); bs.close(); }
    }, 3000);
}
</script>
</html>